---
# 申請 SSL 憑證的工作流程
- name: 為 certbot 先安裝 epel 套件庫
  yum:
    name: epel-release
    state: latest
  become: yes
  become_user: root

- name: 安裝 certbot
  yum:
    name: certbot
    state: latest
  become: yes
  become_user: root  

- name: 安裝 python2-certbot-apache
  yum:
    name: python2-certbot-apache
    state: latest
  become: yes
  become_user: root

- name: 安裝 ansible expect 模組要用的 python pexpect 模組
  pip:
    name: pexpect
  become: yes
  become_user: root

- name: 讀取申請 SSL 憑證的參數
  include_vars: ./vars-request-ssl-certificate.yml

- name: 申請 SSL 憑證
  expect:
    command: "certbot --apache --domains {{ host_name }}"
    responses:
      (?i)email: "{{ ssl_email }}"
      (?i)Terms of Service: "{{ ssl_Terms_of_Service }}"
      (?i)Electronic Frontier: "{{ ssl_Electronic_Frontier }}"
      # certbot 會根據這個選項決定是否要將網站導向以 https 連接，回答 1 是不要，2 是要。
      # 因為我打算自行調整 httpd 設定來載入 certbot 在 /etc/letsencrypt/ 裡面提供的 options-ssl-apache.conf 檔案，所以這邊選 1。
      (?i)redirect: "1"
      # 若要申請憑證的系統上已有目標憑證，則系統會拋出下列問題詢問接下來要做什麼：
      # You have an existing certificate that has exactly the same domains or certificate name you requested and isn't close to expiry.
      # (ref: /etc/letsencrypt/renewal/your-domain.com)
      # What would you like to do?
      # 1: Attempt to reinstall this existing certificate
      # 2: Renew & replace the cert (limit ~5 per 7 days)
      # Select the appropriate number [1-2] then [enter] (press 'c' to cancel)cate", "2: Renew & replace the cert (limit ~5 per 7 days)
      (?i)existing: "{{ ssl_renew_or_cancel }}"
  become: yes
  become_user: root
  # 設定 ignore errors 的原因是為了在 certbot 申請超出上限時，可以不會導致後續流程出錯。
  ignore_errors: yes

- name: 設定憑證自動更新的排程
  cron:
    name: "建立 certbot 更新 apache 憑證的排程"
    job: "certbot renew --apache"
    user: root
    # 只有要設定執行時間的欄位才要特別寫出來。若想採用預設值「*」就不必寫，否則 ansible 會報錯。
    minute: 0
    hour: 0
    weekday: "{{ ssl_weekly_renew_day }}"
    state: present
  # 就算有指定 crontab 使用者，become user 這兩項設定也要加上去，否則會無法執行
  become: yes
  become_user: root
